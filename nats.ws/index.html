<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Simple</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <!-- a place to record messages -->
    <div id="messages" class="container"></div>
    <!-- load a script -->
    <script type="module">
      import {
        connect,
        StringCodec,
        jwtAuthenticator,
        credsAuthenticator,
      } from "./nats.mjs";

      // add an entry to the document
      function addEntry(s) {
        const p = document.createElement("pre");
        p.appendChild(document.createTextNode(s));
        document.getElementById("messages").appendChild(p);
      }

      function bytes(str) {
        var data = [];

        for (var i = 0; i < str.length; ++i) {
          var code = str.charCodeAt(i);

          data = data.concat([code]);
        }

        return data;
      }

      const sc = StringCodec();

      const init = async function () {
        // create a connection
        const nc = await connect({
          // servers: "wss://nats.appscode.ninja:443",
          servers: "ws://localhost:9222",
          authenticator: jwtAuthenticator(
            "eyJ0eXAiOiJKV1QiLCJhbGciOiJlZDI1NTE5LW5rZXkifQ.eyJqdGkiOiJSUEFUTFNDVkI0RlZPWE9CVlhMMjNKNE1TTjJEQ1Y0T1hYTTUzUVJaU1Y0Tlc2UFVKRUNBIiwiaWF0IjoxNjExNjY3NzgwLCJpc3MiOiJBQVdST083NVFXTU9NMloyWEpQNDY2NkNMQ0k1Q1VTSDIzSUpQWlVBQUdGVUlTSFJEVUJEVEdKRyIsIm5hbWUiOiJ4Iiwic3ViIjoiVUFGVE5OTDVSNVlOSFZKTEdMQ0VLT05JNUNRV01SWTdaRlZVWkNKWlBaUUhUMjNER0VGMkxCWkgiLCJuYXRzIjp7InB1YiI6e30sInN1YiI6e30sInN1YnMiOi0xLCJkYXRhIjotMSwicGF5bG9hZCI6LTEsInR5cGUiOiJ1c2VyIiwidmVyc2lvbiI6Mn19.z92SvSkdGXHaDC-bmU0bCIOc_tqHLZLFKJ_g_L_bTqFw7yLoQ7thgBaIgEQTNvSa62JAiX6YHoJCilz5-hASBg",
            bytes("SUAPZF3HKKUXQGMIYATBSUMXLOFCQ2XXYZV4MDIOIZIN6ZUO5KKMNXQNCA")
          ),
          ws: true,
        });
        addEntry("connected to NATS!");

        (async () => {
          addEntry("listening to channel `Notifications`");
          const chat = nc.subscribe("Notifications");
          for await (const m of chat) {
            addEntry(`message : ${sc.decode(m.data)}`);
          }
          addEntry("listened to channel `Notifications`");
        })().then();

        // (async () => {
        //   await setInterval(() => {
        //     nc.publish("Notifications", sc.encode("Self:   Hello there"));
        //     addEntry("Published a message to `Events`");
        //   }, 3000);
        // })().then();
      };
      init();
    </script>
  </body>
</html>
